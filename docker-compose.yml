version: '3.7'
services:
  vault:
    image: vault:1.14.0
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: 'root'
      VAULT_DEV_LISTEN_ADDRESS: '0.0.0.0:8200'
    ports:
      - '8200:8200'
    command: server -dev -dev-root-token-id=root

  prometheus:
    image: prom/prometheus:v2.47.0
    ports:
      - '9090:9090'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro

  fluentd:
    image: fluent/fluentd:v1.16-1
    environment:
      - FLUENTD_CONF=fluent.conf
    volumes:
      - ./monitoring/fluent.conf:/fluentd/etc/fluent.conf

  agent:
    build: .
    environment:
      - AGENT_CONFIG_PATH=/workspace/agent/agent_config.json
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=root
    ports:
      - '8000:8000'
    depends_on:
      - vault
      - prometheus
    volumes:
      - .:/workspace
    command: ["python", "-m", "agent.agent_runner", "--watch"]
  mcp:
    build: .
    environment:
      - AGENT_CONFIG_PATH=/workspace/agent/agent_config.json
      - AGENT_API_TOKEN=changeme
      - VAULT_ADDR=http://vault:8200
    ports:
      - '8080:8080'
    depends_on:
      - vault
    volumes:
      - .:/workspace
    command: ["python", "-m", "agent.mcp_server"]
