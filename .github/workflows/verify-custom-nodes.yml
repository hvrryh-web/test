name: Verify Custom Nodes

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - '.github/workflows/verify-custom-nodes.yml'
      - 'resources/comfy/workflows/**'
      - 'resources/comfy/custom_nodes.txt'

jobs:
  verify-nodes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check custom node references
        run: |
          python - <<'PY'
          from pathlib import Path
          import json

          allowed = set(Path("resources/comfy/custom_nodes.txt").read_text().split())
          workflow_dir = Path("resources/comfy/workflows")
          missing = {}
          for wf in workflow_dir.glob("*.json"):
            data = json.loads(wf.read_text())
            referenced = set(data.get("custom_nodes", []))
            missing_nodes = referenced - allowed
            if missing_nodes:
              missing[wf.name] = sorted(missing_nodes)
          if missing:
            for wf, nodes in missing.items():
              print(f"Workflow {wf} references missing custom nodes: {', '.join(nodes)}")
            raise SystemExit(1)
          print("All workflows reference available custom nodes")
          PY

  smoke-render:
    runs-on: ubuntu-latest
    needs: verify-nodes
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Z-Image Turbo smoke render
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          import hashlib

          workflow = Path("resources/comfy/workflows/sample_workflow.json")
          data = json.loads(workflow.read_text())
          seed = data["metadata"].get("seed", 0)
          assets = [Path(p) for p in data.get("assets", {}).get("inputs", [])]

          digest = hashlib.sha256()
          for asset in assets:
            digest.update(asset.read_bytes())
          digest.update(str(seed).encode())

          rendered = digest.hexdigest()
          expected_path = Path(data.get("assets", {}).get("expected", "rendered.txt"))
          expected_path.write_text(rendered)
          print(f"Simulated Z-Image Turbo render with seed {seed}: {rendered}")
          PY
