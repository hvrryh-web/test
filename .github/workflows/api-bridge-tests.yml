name: API Bridge Tests

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - '.github/workflows/api-bridge-tests.yml'
      - 'agent/**'
      - 'scripts/**'
      - 'tests/**'
      - 'resources/comfy/**'

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run API bridge and script tests
        run: |
          pytest tests/test_mcp_server.py tests/test_chatgpt_adapter.py

  smoke-render:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Z-Image Turbo smoke render
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          import hashlib

          workflow = Path("resources/comfy/workflows/sample_workflow.json")
          data = json.loads(workflow.read_text())
          seed = data["metadata"].get("seed", 0)
          assets = [Path(p) for p in data.get("assets", {}).get("inputs", [])]

          digest = hashlib.sha256()
          for asset in assets:
            digest.update(asset.read_bytes())
          digest.update(str(seed).encode())

          rendered = digest.hexdigest()
          expected_path = Path(data.get("assets", {}).get("expected", "rendered.txt"))
          expected_path.write_text(rendered)
          print(f"Simulated Z-Image Turbo render with seed {seed}: {rendered}")
          PY
