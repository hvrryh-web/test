<!--
This file is autogenerated by an AI assistant. Please review before applying to projects.
-->
# Copilot / AI Agent Guidance for this repo

This file contains concise, repository-specific guidance for AI coding agents (Copilot-style) working on this project. Focus on safe actions, key architectural points, test/run workflows, and where to extend functionality.

## Quick Overview (big picture)
- agent/ -- Python harness that reads tasks from `resources/sample_tasks.xlsx`, processes tasks, and writes outputs to `exports/` and `resources/`.
- agent/agent_runner.py -- main orchestrator: reads tasks, routes to handlers, runs metrics, logging, Vault lookups.
- agent/tasks.py -- reusable, functional small task helpers (e.g., `summarize_data`, `write_summary`).
- agent/actions.py -- higher-level actions (exports, DB queries, email stubs). Prefer `tasks.py` for shared utilities; `actions.py` for external-facing behaviors.
- agent/executor.py -- runs external commands or scripts under resource limits and applies `security/agent_policy.yaml` checks.
- agent/mcp_server.py -- Minimal REST endpoint to add tasks to `resources/sample_tasks.xlsx`.
- agent/vault_client.py -- Fetch secrets from HashiCorp Vault or environment fallbacks.
- resources/ -- input data (sample_tasks.xlsx, sample_data.xlsx) and generator script `generate_sample_xlsx.py`.

## Safe Workflows / How to run
- Local dev (quick):
  - ./scripts/bootstrap_local.sh
  - source .venv/bin/activate
  - python resources/generate_sample_xlsx.py
  - python -m agent.agent_runner --process-tasks  # run once to process all tasks
  - python -m agent.agent_runner --watch  # watch tasks file for changes
- Docker:
  - docker-compose up --build  # starts agent, mcp server, vault, prometheus
  - Agent logs: `AGENT_LOG_FILE` or `/agent/agent.log` depending on config
- Vagrant/VM: `vagrant up` & `vagrant ssh` to run the above inside VM
- Tests: `./scripts/run_tests.sh` (runs pytest). Tests expect exports in `exports/` and `summary.xlsx` in `resources/`.

## Important files & config
- `agent/agent_config.json` — Default config (data_dir, tasks_file, metrics_port, vault details, api_token). Use `AGENT_CONFIG_PATH` env var to override during testing and local runs.
- `security/agent_policy.yaml` — Central list of allowed actions and whitelisted scripts. `executor.Policy` uses this file for enforcement; update it when you add new commands.
- `security/seccomp.json` — Used by `executor.run_in_docker` as container seccomp profile.
- `exports/` and `resources/` — recommended directories to read from / write to. Avoid touching other areas unless necessary.

## Conventions & patterns (project-specific)
- Task descriptions encode action types as simple strings (case-insensitive): e.g., `Summarize sample_data.xlsx`, `DB_QUERY: SELECT * FROM sample`, `EXPORT_CSV: export sample_data`, `SEND_EMAIL:to=foo@bar;subject=Hi;body=Hello`, `RUN_COMMAND: ...`.
- The orchestrator (agent_runner.py) matches substrings in `description` to route to actions. Implement new actions by adding patterns in `agent_runner.py` and helper functions in `agent/tasks.py` or `agent/actions.py`.
- Prefer to write outputs to `exports/` or new `resources/*.updated` files (the harness writes `sample_tasks.xlsx.updated` to avoid overwriting original). Tests rely on these files.
- Avoid external side-effects in repository code: S3 uploads and emails are stubbed (write to `exports/` instead of executing network calls). If adding network calls, use `agent/vault_client.py` to fetch secrets and add clear audit logging.
- Use `executor.run_safe_command` and `run_in_docker` for commands: these respect resource limits and the policy.

## Developer workflows & test patterns
- Unit tests run with `pytest` and expect working with the repo root; they insert `AGENT_CONFIG_PATH` pointing to a temporary config when needed.
- Tests rely on being able to import `agent` as a package; use `python -m agent.agent_runner` in scripts to ensure PAth correctness.
- When adding a feature, add a test under `tests/` to validate expected outputs (new rows in `exports/`, new entry in `resources/*.updated`, or new endpoints in `mcp_server`).

## Security & vault usage
- Do not store credentials in repository or resources (use `resources/credentials_template.xlsx`).
- Use Vault to fetch secrets in `agent/vault_client.py` and fall back to environment variables only when necessary.
- Always consult `security/agent_policy.yaml` before adding any new `run_command` entries or whitelisted scripts.

## Integration points & external dependencies
- Vault (KV v2) for secrets (Vault dev container provided in docker-compose for development).
- Optional S3 SDK (boto3) for uploads; code falls back to local stub if credentials are missing.
- Prometheus metrics: `agent/metrics_server.py` (port 8000 by default) and `docker-compose.yml` includes Prometheus.

- ## Debugging tips (for AI agents)
- If agent actions fail with pandas errors, inspect `agent/tasks.py` and `resources/sample_data.xlsx` shapes; pandas `read_excel` can return a `dict` instead of a `DataFrame` when multiple sheets are requested — prefer specifying `sheet_name` explicitly or validate the loaded object type before calling `df.select_dtypes(...)`.
- Use `AGENT_CONFIG_PATH` to point to a temp config when running tests or debugging locally.
- Check `agent/agent.log` for structured JSON logs and 'taskName' entries used in logs — helpful for tracing task executions.

## Adding new features (concise checklist)
1. Add helper in `agent/tasks.py` or `agent/actions.py` depending on scope.
2. Update `agent/agent_runner.py` to parse description patterns and call your helper.
3. Add or update `security/agent_policy.yaml` to allow new commands or scripts if needed.
4. Add or update unit tests under `tests/` and/or integration test for `mcp_server`.
5. Run `./scripts/run_tests.sh` and update docs (`docs/agent_task_examples.md`) if the behavior changes.
6. If you add a public API endpoint, update `README.md`, `docs/agent_playbook.md`, and add or update tests in `tests/test_mcp_server.py`.

## Notable code caveats
- `agent/README.md` contains merge conflict markers; do not rely on that file for canonical commands — use `README.md` and direct module invocation instead.
- There is some duplicated functionality: `summarize_data` exists in both `agent/tasks.py` and `agent/actions.py`; prefer `agent/tasks.py` for testable pure functions and `actions.py` for side-effecting behaviors.

---
If anything in this guidance is unclear or incomplete, please tell me which area you'd like expanded (examples, code snippets, or a task-specific example) and I'll update this file.
